<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Multiplayer Chess</title>
  <style>
    * {
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', sans-serif;
      margin: 0;
      background: #f4f4f4;
      color: #333;
    }

    header {
      background: #1e1e2f;
      color: white;
      padding: 1rem;
      text-align: center;
      font-size: 1.5rem;
    }

    .container {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 1rem;
    }

    .lobby {
      margin-bottom: 1.5rem;
      background: white;
      padding: 1rem;
      border-radius: 10px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
      width: 90%;
      max-width: 400px;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    input, button {
      padding: 0.6rem 1rem;
      font-size: 1rem;
      border-radius: 6px;
      border: 1px solid #ccc;
      width: 100%;
    }

    button {
      background: #4a90e2;
      color: white;
      border: none;
      cursor: pointer;
    }

    button:hover {
      background: #357ab7;
    }

    .chess-board {
      display: grid;
      grid-template-columns: repeat(8, 1fr);
      max-width: 480px;
      width: 100%;
      aspect-ratio: 1;
      border: 2px solid #222;
    }

    .cell {
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2rem;
      user-select: none;
    }

    .white { background: #eee; }
    .black { background: #666; color: white; }

    .selected {
      outline: 3px solid yellow;
    }
  </style>
</head>
<body>
  <header>Multiplayer Chess</header>
  <div class="container">
    <div class="lobby">
      <input type="text" id="username" placeholder="Your name" />
      <input type="text" id="room-code" placeholder="Room code to join (leave blank to create)" />
      <button id="start-game">Start / Join Game</button>
    </div>

    <div id="status"></div>
    <div id="game" class="chess-board" style="display:none;"></div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.8.0/firebase-app.js";
    import { getDatabase, ref, set, get, onValue } from "https://www.gstatic.com/firebasejs/11.8.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBDHZpDfKz711k2agTq4ekGU7-iN_p99mc",
      authDomain: "icqclone.firebaseapp.com",
      databaseURL: "https://icqclone-default-rtdb.firebaseio.com",
      projectId: "icqclone",
      storageBucket: "icqclone.appspot.com",
      messagingSenderId: "922649039358",
      appId: "1:922649039358:web:fbdd0a0e21d64e4d32f0af"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    let boardEl = document.getElementById("game");
    let startBtn = document.getElementById("start-game");
    let usernameEl = document.getElementById("username");
    let roomCodeEl = document.getElementById("room-code");
    let statusEl = document.getElementById("status");

    let chess = null;
    let roomId = "";
    let playerColor = "";

    const piecesUnicode = {
      p: "♟", r: "♜", n: "♞", b: "♝", q: "♛", k: "♚",
      P: "♙", R: "♖", N: "♘", B: "♗", Q: "♕", K: "♔"
    };

    startBtn.onclick = async () => {
      const name = usernameEl.value.trim();
      const code = roomCodeEl.value.trim();

      if (!name) return alert("Enter your name");

      if (code === "") {
        roomId = Math.random().toString(36).substring(2, 8);
        playerColor = "w";
        chess = new Chess();
        await set(ref(db, "rooms/" + roomId), {
          board: chess.fen(),
          turn: "w",
          players: { white: name }
        });
        alert("Room created: " + roomId);
      } else {
        const snap = await get(ref(db, "rooms/" + code));
        if (!snap.exists()) return alert("Room not found");

        const data = snap.val();
        if (data.players?.black) return alert("Room full");

        roomId = code;
        playerColor = "b";
        await set(ref(db, "rooms/" + roomId + "/players/black"), name);
        alert("Joined room: " + roomId);
      }

      initGameListeners();
    };

    function initGameListeners() {
      onValue(ref(db, "rooms/" + roomId + "/board"), (snap) => {
        if (!snap.exists()) return;
        if (!chess) chess = new Chess();
        chess.load(snap.val());
        renderBoard();
      });

      onValue(ref(db, "rooms/" + roomId + "/turn"), (snap) => {
        const turn = snap.val();
        statusEl.innerText = turn === playerColor
          ? "Your turn"
          : "Waiting for opponent...";
      });

      boardEl.style.display = "grid";
    }

    function renderBoard() {
      boardEl.innerHTML = "";
      const board = chess.board();
      board.forEach((row, y) => {
        row.forEach((cell, x) => {
          const index = playerColor === "w" ? y * 8 + x : (7 - y) * 8 + (7 - x);
          const square = document.createElement("div");
          square.className = `cell ${(x + y) % 2 === 0 ? "white" : "black"}`;
          square.dataset.x = x;
          square.dataset.y = y;

          if (cell) {
            square.textContent = piecesUnicode[cell.color === "w" ? cell.type.toUpperCase() : cell.type];
          }

          square.onclick = () => handleClick(x, y);
          boardEl.appendChild(square);
        });
      });
    }

    let selected = null;
    function handleClick(x, y) {
      if (!chess || chess.turn() !== playerColor) return;

      const square = String.fromCharCode(97 + x) + (8 - y);
      const piece = chess.get(square);

      if (selected) {
        // Try move
        const move = chess.move({ from: selected, to: square, promotion: "q" });

        if (move) {
          // Valid move
          set(ref(db, "rooms/" + roomId + "/board"), chess.fen());
          set(ref(db, "rooms/" + roomId + "/turn"), chess.turn());
          selected = null;
          renderBoard();

          // Check for game end
          if (chess.game_over()) {
            alert("Game Over: " + (
              chess.in_checkmate() ? (chess.turn() === "w" ? "Black wins!" : "White wins!") :
              chess.in_stalemate() ? "Stalemate!" :
              "Draw!"
            ));
          }
        } else {
          selected = null;
          renderBoard();
        }
      } else if (piece && piece.color === playerColor) {
        selected = square;
        highlightMoves(square);
      }
    }

    function highlightMoves(square) {
      const moves = chess.moves({ square, verbose: true });
      renderBoard();

      moves.forEach(m => {
        const [x, y] = [m.to.charCodeAt(0) - 97, 8 - parseInt(m.to[1])];
        const index = playerColor === "w" ? y * 8 + x : (7 - y) * 8 + (7 - x);
        const cell = boardEl.children[index];
        if (cell) {
          cell.style.outline = "2px solid yellow";
        }
      });

      const [x, y] = [square.charCodeAt(0) - 97, 8 - parseInt(square[1])];
      const index = playerColor === "w" ? y * 8 + x : (7 - y) * 8 + (7 - x);
      boardEl.children[index].style.outline = "2px solid red";
    }
  </script>
</body>
</html>
